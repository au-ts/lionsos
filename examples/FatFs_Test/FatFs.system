<?xml version="1.0" encoding="UTF-8"?>
<!--
 Copyright 2023, UNSW

 SPDX-License-Identifier: BSD-2-Clause
-->
<system>
    <memory_region name="blk_driver_vm_ram" size="0x8_000_000" page_size="0x200_000" />
    <memory_region name="uart" size="0x1_000" phys_addr="0x9000000" />
    <memory_region name="gic_vcpu" size="0x1_000" phys_addr="0x8040000" />
    <memory_region name="req_client" size="0x200_000" page_size="0x200_000"/>
    <memory_region name="resp_client" size="0x200_000" page_size="0x200_000"/>
    <!-- Memory region for coroutine stack -->
    <memory_region name="coroutine_stack1" size="0x40_000" page_size="0x1000"/>
    <memory_region name="coroutine_stack2" size="0x40_000" page_size="0x1000"/>
    <memory_region name="coroutine_stack3" size="0x40_000" page_size="0x1000"/>
    <memory_region name="coroutine_stack4" size="0x40_000" page_size="0x1000"/>

    <memory_region name="coroutine_client" size="0x40_000" page_size="0x1000"/>

    <!-- File system test client -->
    <protection_domain name="Client" priority="50" pp="true">
        <program_image path="Client.elf" />
        <map mr="data_blk_vmm_1" vaddr="0x30600000" perms="rw" cached="true" />
        <map mr="req_client" vaddr="0x31000000" perms="rw" cached="true" />
        <map mr="resp_client" vaddr="0x31200000" perms="rw" cached="true" />
        <map mr="coroutine_client" vaddr="0x31600000" perms="rw" cached="true" setvar_vaddr="Coroutine_STACK" />
    </protection_domain>

    <!-- FAT32 File system -->
    <protection_domain name="FatFs" priority="100" pp="true">
        <program_image path="FatFs.elf" />
        <map mr="req_blk_vmm_1" vaddr="0x30200000" perms="rw" cached="true" setvar_vaddr="request" />
        <map mr="resp_blk_vmm_1" vaddr="0x30400000" perms="rw" cached="true" setvar_vaddr="response" />
        <map mr="data_blk_vmm_1" vaddr="0x30600000" perms="rw" cached="true" />
        <map mr="req_client" vaddr="0x31000000" perms="rw" cached="true" setvar_vaddr="FATfs_command_queue"/>
        <map mr="resp_client" vaddr="0x31200000" perms="rw" cached="true" setvar_vaddr="FATfs_completion_queue"/>
        <map mr="coroutine_stack1" vaddr="0x32000000" perms="rw" cached="true" setvar_vaddr="Coroutine_STACK_ONE" />
        <map mr="coroutine_stack2" vaddr="0x32050000" perms="rw" cached="true" setvar_vaddr="Coroutine_STACK_TWO" />
        <map mr="coroutine_stack3" vaddr="0x32100000" perms="rw" cached="true" setvar_vaddr="Coroutine_STACK_THREE" />
        <map mr="coroutine_stack4" vaddr="0x32150000" perms="rw" cached="true" setvar_vaddr="Coroutine_STACK_FOUR" />
    </protection_domain>

    <channel>
        <end pd="Client" id="1"/>
        <end pd="FatFs" id="1"/>
    </channel>

    <!-- Blk config region -->
    <memory_region name="blk_config_vmm_1" size="0x1000" page_size="0x1000" />
    <memory_region name="blk_config_vmm_2" size="0x1000" page_size="0x1000" />
    <!-- Shared memory for the actual data transfered -->
    <memory_region name="data_blk_vmm_1" size="0x200_000" page_size="0x200_000" />
    <memory_region name="data_blk_vmm_2" size="0x200_000" page_size="0x200_000" />
    <!--
        Regions for the shared queues used by the driver vm and client vm
    -->
    <memory_region name="req_blk_vmm_1" size="0x200_000" page_size="0x200_000"/>
    <memory_region name="req_blk_vmm_2" size="0x200_000" page_size="0x200_000"/>
    <memory_region name="resp_blk_vmm_1" size="0x200_000" page_size="0x200_000"/>
    <memory_region name="resp_blk_vmm_2" size="0x200_000" page_size="0x200_000"/>

    <protection_domain name="BLK_DRIVER_VMM" priority="200" budget="100" period="400">
        <program_image path="blk_driver_vmm.elf" />
        <map mr="blk_driver_vm_ram" vaddr="0x40000000" perms="rw" setvar_vaddr="guest_ram_vaddr" />

        <!-- sDDF block -->
        <virtual_machine name="blk_driver_linux" id="0" priority="200">
            <map mr="blk_driver_vm_ram" vaddr="0x40000000" perms="rwx" />
            <map mr="gic_vcpu" vaddr="0x8010000" perms="rw" cached="false" />

            <!-- sDDF block -->
            <!-- blk config region -->
            <map mr="blk_config_vmm_1" vaddr="0x30000000" perms="rw" cached="true" />
            <map mr="blk_config_vmm_2" vaddr="0x31000000" perms="rw" cached="true" />
            <!-- shared memory for queues -->
            <map mr="req_blk_vmm_1" vaddr="0x30200000" perms="rw" cached="true" />
            <map mr="req_blk_vmm_2" vaddr="0x31200000" perms="rw" cached="true" />
            <map mr="resp_blk_vmm_1" vaddr="0x30400000" perms="rw" cached="true" />
            <map mr="resp_blk_vmm_2" vaddr="0x31400000" perms="rw" cached="true" />
            <!-- sDDF data region -->
            <map mr="data_blk_vmm_1" vaddr="0x30600000" perms="rw" cached="true" />
            <map mr="data_blk_vmm_2" vaddr="0x31600000" perms="rw" cached="true" />
        </virtual_machine>
    </protection_domain>

    <channel>
        <end pd="FatFs" id="2"/>
        <end pd="BLK_DRIVER_VMM" id="3"/>
    </channel>
</system>
